name: Read changeset status

inputs:
  args:
    description: Additional arguments to pass to 'yarn changeset status'
    required: false

outputs:
  base_branch:
    description: The base branch of the changeset
    value: ${{ steps.status.outputs.base_branch }}
  name:
    description: The name of the package
    value: ${{ steps.status.outputs.name }}
  type:
    description: "The type of version bump: 'patch' | 'minor' | 'major'"
    value: ${{ steps.status.outputs.type }}
  old_version:
    description: The old version of the package
    value: ${{ steps.status.outputs.old_version }}
  new_version:
    description: The new version of the package
    value: ${{ steps.status.outputs.new_version }}

runs:
  using: composite
  steps:
    - name: Read Changeset Status
      shell: bash
      id: status
      run: |
        OUTPUT=$(mktemp "${{runner.temp}}/changeset-output.XXXXXX.json")

        if [ ! -f "$OUTPUT" ]; then
          echo "ðŸš¨ Error: Failed to create temp file at: $OUTPUT"
          exit 1
        fi
        echo "âœ… Temporary file created at: $OUTPUT"

        # Run the changeset status command with relative path output
        # and suppress the error for cases when no changeset is found
        yarn changeset status ${{ inputs.args }} --output $(realpath --relative-to . "$OUTPUT") 2>/dev/null || true


        # The OUTPUT file might be empty, so the .releases value should default to an empty array.
        # If the .releases value is empty, then the changeset is not ready to be released
        if jq -e '(.releases // [] | length) == 0' "$OUTPUT" > /dev/null; then
          echo "â© No changeset found"
        else
          NAME=$(jq -r '.releases[0].name' "$OUTPUT")
          TYPE=$(jq -r '.releases[0].type' "$OUTPUT")
          OLD_VERSION=$(jq -r '.releases[0].oldVersion' "$OUTPUT")
          NEW_VERSION=$(jq -r '.releases[0].newVersion' "$OUTPUT")

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # print the github output
          echo "ðŸ“¦ Changeset found:"
          cat $GITHUB_OUTPUT
        fi

        BASE_BRANCH=$(jq -r '.baseBranch' .changeset/config.json)
        echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
